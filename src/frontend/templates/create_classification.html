<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TrainMe | Classification</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    {% extends 'pattern.html' %}
    {% block content %}
    <main class="container mx-auto flex flex-row space-x-4">
        <div class="mt-4 w-1/2">
            <h1 class="text-xl font-bold mb-4">Создать классификационный обработчик</h1>
            <form id="create-handler-form" class="space-y-4" method="post" enctype="multipart/form-data">
                <div>
                    <label for="endpoint_path" class="block font-medium">Путь конечной точки:</label>
                    <input type="text" id="endpoint_path" name="endpoint_path" required class="mt-1 p-2 border border-gray-300 rounded w-full">
                </div>

                <div>
                    <label for="algorithm" class="block font-medium">Выберите алгоритм:</label>
                    <select id="algorithm" name="algorithm" required class="mt-1 p-2 border border-gray-300 rounded w-full">
                        <option value="logistic_regression">Логистическая регрессия</option>
                        <option value="boost">Градиентный бустинг</option>
                    </select>
                </div>
                <div>
                    <label for="dataset" class="block font-medium text-gray-700 mb-2">Загрузите набор данных (CSV):</label>
                    <input type="file" id="dataset" name="dataset" accept=".csv" required class="sr-only" />
                    <label for="dataset" class="transition bg-transparent hover:bg-black text-black font-semibold hover:text-white py-2 px-4 border border-black hover:border-transparent rounded cursor-pointer">
                        Выбрать файл
                    </label>
                    <span id="file-name" class="mt-2 text-gray-700 ml-2"></span>
                </div>

                <div>
                    <label for="label_name" class="block font-medium">Имя метки:</label>
                    <input type="text" id="label_name" name="label_name" required class="mt-1 p-2 border border-gray-300 rounded w-full">
                </div>

                <button type="submit" class="bg-black text-white py-2 px-4 rounded w-full">Создать обработчик</button>
            </form>
            <div id="response" class="mt-4"></div>
        </div>
        <!-- Уведомление при успехе-->
        <div id="notification" class="hidden fixed bottom-24 right-4 bg-green-500 text-white font-semibold tracking-wide flex items-center w-max max-w-sm p-4 rounded-md shadow-md shadow-green-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-[18px] shrink-0 fill-white inline mr-3" viewBox="0 0 512 512">
                  <ellipse cx="256" cy="256" fill="#fff" data-original="#fff" rx="256" ry="255.832" />
                  <path class="fill-green-500" d="m235.472 392.08-121.04-94.296 34.416-44.168 74.328 57.904 122.672-177.016 46.032 31.888z" data-original="#ffffff" />
            </svg>
            <span class="block sm:inline text-sm mr-3">Update successfully</span>
        </div>
        <div class="mt-4 w-1/2 p-4 bg-gray-100 rounded">
    <h2 class="text-lg font-bold mb-4">Инструкция по созданию классификационного обработчика</h2>
    <p class="mb-2">Создание классификационного обработчика позволяет вам автоматизировать процесс классификации данных. Выберите путь конечной точки, алгоритм и загрузите набор данных для начала работы.</p>

    <h3 class="font-semibold mt-4">Выбор алгоритма</h3>
    <p class="mb-2">Доступные алгоритмы:</p>
    <ul class="list-disc ml-5">
        <li><strong>Логистическая регрессия</strong> - простой и эффективный метод для бинарной классификации. Подходит для линейно разделимых данных.</li>
        <li><strong>Градиентный бустинг</strong> - мощный алгоритм, который работает хорошо с сложными зависимостями. Подходит для многоклассовой классификации.</li>
    </ul>

    <h3 class="font-semibold mt-4">Загрузка данных</h3>
    <p class="mb-2">Файл данных должен быть в формате CSV и содержать заголовки колонок. Убедитесь, что ваши данные очищены и правильно отформатированы для лучшей производительности алгоритма.</p>

    <h3 class="font-semibold mt-4">Дополнительные ресурсы</h3>
    <ul class="list-disc ml-5">
        <li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html" target="_blank" class="text-blue-600 hover:underline">Документация по Логистической регрессии</a></li>
        <li><a href="https://scikit-learn.org/stable/modules/ensemble.html#gradient-boosting" target="_blank" class="text-blue-600 hover:underline">Документация по Градиентному бустингу</a></li>
    </ul>

    <p class="mt-4">После заполнения всех полей и нажатия кнопки "Создать обработчик", ваш классификационный обработчик будет создан, и вы получите ответ с результатами.</p>
</div>
    </main>

    <script>
        document.getElementById('create-handler-form').addEventListener('submit', async (event) => {
            event.preventDefault(); // Отменяем стандартное поведение формы

            const formData = new FormData(event.target); // Создаем объект FormData
            const responseDiv = document.getElementById('response');

            // Получаем базовый URL
            const baseUrl = window.location.origin;

            // Отправляем данные
            try {
                const response = await fetch(`/ml/classification/create?endpoint_path=${encodeURIComponent(event.target.endpoint_path.value)}&algorithm=${encodeURIComponent(event.target.algorithm.value)}&label_name=${encodeURIComponent(event.target.label_name.value)}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                    },
                    body: formData
                });

                // Получаем статус и респонс
                const statusCode = response.status;
                const statusText = response.statusText;
                let responseBody;

                if (response.ok) {
                    responseBody = await response.json();
                    showNotification();  // Показ уведомления
                } else {
                    responseBody = await response.text();
                }

                // Формируем вывод о статусе ответа
                responseDiv.innerHTML = `
                    <div class="px-4 py-2 border border-gray-300 rounded bg-white shadow">
                        <h2 class="font-bold">Ответ сервера:</h2>
                        <p>Статус код: <span class="font-semibold">${statusCode} ${statusText}</span></p>
                        <p><strong>Сообщение:</strong> ${responseBody.message}</p>
                        <p><strong>Алгоритм:</strong> ${responseBody.ml_algorithm}</p>
                        <p><strong>Путь конечной точки:</strong> <a href="${baseUrl}${responseBody.endpoint_path}" class="text-blue-600 hover:underline">${baseUrl}${responseBody.endpoint_path}</a></p>
                    </div>
                `;
            } catch (error) {
                responseDiv.innerHTML = `<p class="text-red-600">Ошибка: ${error.message}</p>`;
            }
        });

        // Функция для показа уведомления
        function showNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('hidden'); // Показываем уведомление

            // Скрываем уведомление через 3 секунды
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // Обработчик для отображения имени файла
        document.getElementById('dataset').addEventListener('change', (event) => {
            const fileName = event.target.files[0] ? event.target.files[0].name : 'Не выбран файл';
            document.getElementById('file-name').textContent = fileName;
        });
    </script>
    {% endblock %}
</body>
</html>
